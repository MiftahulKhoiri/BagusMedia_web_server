<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN TERMINAL - BAGUS MEDIA SERVER</title>

    <link rel="stylesheet" href="/static/css/admin-hacker.css">
</head>
<body>

<canvas id="matrixCanvas"></canvas>

<div class="terminal">
    <h1 class="title">▌ BAGUS MEDIA SERVER ▌</h1>

    <!-- ============================
         REALTIME SYSTEM MONITOR
    ============================ -->
    <div class="section">
        <div class="section-title">[ REALTIME MONITOR ]</div>

        <div class="monitor-box">
            <p>CPU: <span id="cpu-val">0%</span></p>
            <div class="bar"><div id="cpu-bar" class="bar-fill"></div></div>

            <p>RAM: <span id="ram-val">0%</span></p>
            <div class="bar"><div id="ram-bar" class="bar-fill"></div></div>

            <p>DISK: <span id="disk-val">0%</span></p>
            <div class="bar"><div id="disk-bar" class="bar-fill"></div></div>

            <p>Uptime: <span id="uptime-text">{{ info.uptime }}</span></p>
        </div>
    </div>

    <!-- ============================
     REALTIME CHART LEVEL 2
============================ -->
<div class="section">
    <div class="section-title">[ REALTIME PERFORMANCE GRAPH ]</div>

    <canvas id="cpuChart" class="chart"></canvas>
    <canvas id="ramChart" class="chart"></canvas>
    <canvas id="diskChart" class="chart"></canvas>
</div>

    <!-- ============================
         USER MANAGEMENT
    ============================ -->
    <div class="section">
        <div class="section-title">[ USER MANAGEMENT ]</div>

        <table class="user-table">
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Role</th>
                <th>Aksi</th>
            </tr>

            {% for u in users %}
            <tr>
                <td>{{ u[0] }}</td>
                <td>{{ u[1] }}</td>
                <td>{{ u[2] }}</td>
                <td>
                    {% if u[1] != "root" %}
                        <button class="btn warn" onclick="changeRole({{ u[0] }}, 'root')">Set Root</button>
                        <button class="btn" onclick="changeRole({{ u[0] }}, 'user')">Set User</button>
                        <button class="btn danger" onclick="deleteUser({{ u[0] }})">Hapus</button>
                    {% else %}
                        <span class="locked">Locked</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- ============================
         ADMIN TOOLS
    ============================ -->
    <div class="section">
        <div class="section-title">[ ADMIN TOOLS ]</div>

        <div class="tools">
            <button class="btn tool" onclick="location.href='/filemanager'">File Manager</button>
            <button class="btn tool" onclick="location.href='/update'">System Update</button>
            <button class="btn tool" onclick="location.href='/about'">System Info</button>
        </div>
    </div>

    <footer class="footer">© {{ current_year }} BAGUS MEDIA SERVER • TERMINAL MODE</footer>
</div>

<!-- =======================================
     SCRIPT REALTIME MONITOR + MATRIX
======================================= -->
<script src="/static/Js/admin-hacker.js"></script>

<script>
/* =============================
   REALTIME SYSTEM MONITOR
============================= */
async function updateMonitor() {
    try {
        let res = await fetch("/api/monitor");
        let d = await res.json();

        document.getElementById("cpu-val").innerText = d.cpu + "%";
        document.getElementById("cpu-bar").style.width = d.cpu + "%";

        document.getElementById("ram-val").innerText = d.ram_percent + "%";
        document.getElementById("ram-bar").style.width = d.ram_percent + "%";

        document.getElementById("disk-val").innerText = d.disk_percent + "%";
        document.getElementById("disk-bar").style.width = d.disk_percent + "%";
    } catch (e) {
        console.log("Monitor error:", e);
    }
}

setInterval(updateMonitor, 1000);
updateMonitor();
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let cpuData = [];
let ramData = [];
let diskData = [];
let labels = [];

// ========= INIT CHART =========
function createChart(id, label, borderColor) {
    return new Chart(document.getElementById(id), {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: [],
                borderColor: borderColor,
                borderWidth: 2,
                tension: 0.2
            }]
        },
        options: {
            animation: false,
            scales: {
                y: { min: 0, max: 100 }
            }
        }
    });
}

let cpuChart = createChart("cpuChart", "CPU %", "#0f0");
let ramChart = createChart("ramChart", "RAM %", "#3f0");
let diskChart = createChart("diskChart", "Disk %", "#6f0");

// ========= UPDATE CHART =========
async function updateRealtimeCharts() {
    const res = await fetch("/api/monitor");
    const d = await res.json();

    const time = new Date().toLocaleTimeString();

    labels.push(time);
    if (labels.length > 20) labels.shift();

    cpuData.push(d.cpu);
    ramData.push(d.ram_percent);
    diskData.push(d.disk_percent);

    if (cpuData.length > 20) cpuData.shift();
    if (ramData.length > 20) ramData.shift();
    if (diskData.length > 20) diskData.shift();

    cpuChart.data.datasets[0].data = cpuData;
    cpuChart.update();

    ramChart.data.datasets[0].data = ramData;
    ramChart.update();

    diskChart.data.datasets[0].data = diskData;
    diskChart.update();

    // Alarm CPU > 90%
    if (d.cpu > 90) {
        document.body.style.background = "#300";
        console.log("⚠ CPU WARNING!");
        new Audio("/static/sound/beep.mp3").play().catch(()=>{});
    } else {
        document.body.style.background = "";
    }
}

setInterval(updateRealtimeCharts, 1000);
</script>

</body>
</html>